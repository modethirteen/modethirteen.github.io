<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="A consideration for distributed lifecycle tokens..."><meta property="og:type" content="article"><meta property="og:title" content="You May Not Need Service Discovery"><meta property="og:url" content="https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/index.html"><meta property="og:site_name" content="al&#x3D;0x13"><meta property="og:description" content="A consideration for distributed lifecycle tokens..."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/photo-1597733336794-12d05021d510.jpg"><meta property="article:published_time" content="2019-12-24T02:46:30.000Z"><meta property="article:modified_time" content="2020-11-05T19:06:55.000Z"><meta property="article:author" content="James Andrew Vaughn (Andy)"><meta property="article:tag" content="Programming"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="C Sharp"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/photo-1597733336794-12d05021d510.jpg"><meta name="twitter:creator" content="@modethirteen"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>You May Not Need Service Discovery</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="al=0x13" type="application/atom+xml">
</head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Posts</a></li><li><a href="/#projects">Projects</a></li><li><a href="/atom.xml">Atom</a></li><li><a href="/plan">.plan</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="/2020/04/20/interfaces-for-humans-on-an-api-first-platform/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/2019/10/16/impact-mapping-with-graphviz/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&text=You May Not Need Service Discovery"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&is_video=false&description=You May Not Need Service Discovery"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=You May Not Need Service Discovery&body=Check out this article: https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/"><i class="fas fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&name=You May Not Need Service Discovery&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&t=You May Not Need Service Discovery"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">You May Not Need Service Discovery</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">James Andrew Vaughn (Andy)</span></span><div class="postdate"><time datetime="2019-12-24T02:46:30.000Z" itemprop="datePublished">2019-12-23</time></div><div class="article-tag"><i class="fas fa-tag"></i> <a class="tag-link-link" href="/tags/C-Sharp/" rel="tag">C Sharp</a>, <a class="tag-link-link" href="/tags/DevOps/" rel="tag">DevOps</a>, <a class="tag-link-link" href="/tags/Programming/" rel="tag">Programming</a></div></div></header><div class="content" itemprop="articleBody"><p class="description">A consideration for distributed lifecycle tokens...</p><p><img src="/2019/12/23/you-may-not-need-service-discovery/photo-1597733336794-12d05021d510.jpg" alt="Image"><span class="caption">Image: <a target="_blank" rel="noopener" href="https://unsplash.com/@jjying">JJ Ying</a></span></p><p>As modern application architecture is decoupled more and more into independently running services, we’re all once again experiencing the pains that some of us remember from the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Service-oriented_architecture">SOA</a> days in the early 2000s. A popular saying in software engineering is that the two hardest problems in computer science are:</p><ol><li>Cache invalidation</li><li>Naming things</li></ol><p>…and then everyone typically adds a third problem, based on whatever particular stress they are going through at that very moment:</p><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a target="_blank" rel="noopener" href="https://twitter.com/codinghorror/status/506010907021828096"></a></blockquote></div><script async defer src="//platform.twitter.com/widgets.js" charset="utf-8"></script><p>As of this year, my “number three” on the list is:</p><ol start="3"><li>Constantly having to remind myself that in-memory communication between software components is <em>always</em> easier than over the wire</li></ol><p>My inner-voice is there to convince me that breaking a component off of the <em>monolith</em> (that component being what we are all calling a <em>microservice</em> now) probably introduces a range of new problems that can overshadow the original perceived value of decomposing the application in the first place. Even load-balanced monolithic application servers have SOA-like problems that are still there even if the monolith goes away. At <a target="_blank" rel="noopener" href="https://mindtouch.com/">MindTouch</a>, we ran into one that had been hiding in plain sight for nearly a decade.</p><p>We’ve used a <em>progressive</em> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Blue-green_deployment">blue-green deployment</a> for many years to release new software on our shared, multi-tenant SaaS infrastructure. The approach is progressive in-so-far that tenants are switched to new software in batches (to monitor for problems and lessen their impact) as opposed to flipping a switch for all tenants at once.</p><p><img src="/2019/12/23/you-may-not-need-service-discovery/image21.png" alt="Image"></p><p>Tenants are identified by hostname (ex: <code>foo.mindtouch.us</code>, <code>bar.mindtouch.us</code>, etc). Incoming requests are routed to the appropriate pool of EC2-hosted application servers for the requested tenant. If a blue-green deployment is in progress, and the tenant is queued to switch to the new software release but has not yet been moved over to it, the load balancer can still route correctly. This is due to the presence of a site configuration authority: a centralized database of all tenants and their deployments, plus an internal tenant manager application that writes to this database. Deployments are simply a list of EC2 IP addresses that represent the application servers in a particular pool.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;release_20130620&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;161.21.53.204&quot;</span>,</span><br><span class="line">        <span class="string">&quot;178.3.205.241&quot;</span>,</span><br><span class="line">        <span class="string">&quot;211.244.229.69&quot;</span>,</span><br><span class="line">        <span class="string">&quot;137.62.44.231&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;release_20130617&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;210.124.193.170&quot;</span>,</span><br><span class="line">        <span class="string">&quot;177.113.206.133&quot;</span>,</span><br><span class="line">        <span class="string">&quot;222.179.114.209&quot;</span>,</span><br><span class="line">        <span class="string">&quot;7.147.241.158&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2019/12/23/you-may-not-need-service-discovery/image22.png" alt="Image"></p><p>Blue-green can certainly mitigate risk in this “load-balanced application server” architecture. Any software update, regardless of whatever model or methodology you use, will always introduce risk. This particular approach makes it tolerable for us and our users. Due to the requirements that we had when standing up this infrastructure, we chose <a target="_blank" rel="noopener" href="http://www.haproxy.org/">HAProxy</a> over Amazon’s native <a target="_blank" rel="noopener" href="https://aws.amazon.com/elasticloadbalancing">load balancer</a>. This meant that while we <em>could</em> place these application servers in <a target="_blank" rel="noopener" href="https://aws.amazon.com/autoscaling">auto-scaling groups</a>, there wouldn’t be any benefit if our load balancer of choice and our home-grown deployment model couldn’t take advantage of it. If our service ever came under heavy load, we would have to spin-up EC2s manually, provision them with all the requirements to run our software (and install the application software itself) using <a target="_blank" rel="noopener" href="https://puppet.com/">Puppet</a>, then add the EC2 IP address to the application server pool for the live deployment. Historically, this was required so infrequently that automating these steps didn’t seem necessary.</p><p>Until we had a real SaaS business going…</p><p>This year we completed a migration of all application servers and event-driven microservices to containers hosted on <a target="_blank" rel="noopener" href="https://aws.amazon.com/eks">Amazon EKS</a> (k8s). The many reasons behind the switch are deserving of a case study, but the key point that’s relevant to this post is that we could <em>quickly</em> auto-scale application servers (now in k8s <em>pods</em>) <em>and</em> it was becoming necessary to do so. As an added benefit, all load balancing between deployments could be managed within k8s, making the old deployment model of static IP address lists obsolete.</p><p>There was one big problem. The fore-mentioned internal tenant manager can <em>restart</em> tenants - which is required for certain kinds of configuration changes. Each application server, in every container, keeps an in-memory record of the configurations for every tenant that it’s had to serve. Keeping an in-memory copy allows any application server to quickly handle a request for any tenant (so specific tenants need not be pegged to specific containers). In order to restart a tenant, the tenant manager would send a restart HTTP payload to an internal API endpoint on each application server. With k8s managing and auto-scaling all containers, this application had no idea which IP addresses to target - effectively breaking this capability.</p><blockquote><p>We need service discovery!</p><footer><strong>Everyone ever with a one to many or many to many networked service communication problem</strong></footer></blockquote><p>The faulty assumption, out of the gate, is that this tenant manager still needs to know <em>where</em> the downstream application is running. When faced with challenges, we can often gravitate towards what is known or what we are comfortable with. We presume that other options are going to be difficult to achieve. Why not? We obviously chose the simplest option when we first built this! With that presumption in place, we are likely ignoring an <em>even simpler</em> and possibly more elegant solution - because in the last few years we’ve become smarter and better at our craft.</p><p>All the tenant manager needs to know about is one location: where to write a big message on the side of a wall for someone to read later. The message is for any application server that reads it to restart a specific tenant - and every application server knows to check the wall before handling an incoming request, just in case there is new information about the intended tenant for the request. We implemented this with a <em>distributed lifecycle token</em>.</p><p>A distributed lifecycle token is an arbitrary value stored in an authoritative location that downstream applications and services can use to detect upstream changes. If downstream components store the value of the token and later detect that their stored value no longer matches the authoritative source, they can infer some sort of meaning from that. In our use case, they know that the tenant manager has requested the restart of a tenant. Allowing downstream components to <em>eventually</em> take action on, or be triggered by, a write to a data store, an event stream, or a similar authoritative location is a great example of event-driven and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Reactive_programming">reactive programming</a> in use.</p><p>First, we need a connection to a centralized, in-memory data store (such as <a target="_blank" rel="noopener" href="https://memcached.org/">Memcached</a>, <a target="_blank" rel="noopener" href="https://redis.io/">Redis</a>, etc.) that can be accessed by any application server. Any tokens in this data store need to contain some sort of tenant-specific context. The following example is <em>not</em> meant to be representative of a full-featured Memcached client, but rather the minimum required to demonstrate this implementation.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MemcachedClient</span> : <span class="title">IMemcachedClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Fields ---</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMemcachedClient _client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _tenantId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Methods ---</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MemcachedClient</span>(<span class="params"><span class="built_in">string</span> tenantId, IMemcachedClient client</span>)</span> &#123;</span><br><span class="line">        _client = client;</span><br><span class="line">        _siteId = siteId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> key</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _client.Get(NormalizeKey(key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IDictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt; <span class="title">Get</span>(<span class="params">IEnumerable&lt;<span class="built_in">string</span>&gt; keys</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> result = _client.Get(keys.Select(NormalizeKey).ToArray());</span><br><span class="line">        <span class="keyword">return</span> result.ToDictionary(kv =&gt; DenormalizeKey(kv.Key), kv =&gt; kv.Value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">NormalizeKey</span>(<span class="params"><span class="built_in">string</span> key</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.Format(<span class="string">&quot;&#123;0&#125;:&#123;1&#125;&quot;</span>, _siteId, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">DenormalizeKey</span>(<span class="params"><span class="built_in">string</span> key</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key.Substring(_siteId.Length + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Next, we have libraries that manage the initialization and fetching of tokens using our tenant-contextual Memcached client.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDistributedTokenProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Methods ---</span></span><br><span class="line">    <span class="function">IDictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; <span class="title">GetDistributedTokens</span>(<span class="params">IEnumerable&lt;<span class="built_in">string</span>&gt; keys</span>)</span>;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">GetDistributedToken</span>(<span class="params"><span class="built_in">string</span> key</span>)</span>;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">InitToken</span>(<span class="params"><span class="built_in">string</span> key</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DistributeToken</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">string</span> token, TimeSpan ttl</span>)</span>;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">InitDistributedToken</span>(<span class="params"><span class="built_in">string</span> key, TimeSpan ttl</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DistributedTokenProvider</span> : <span class="title">IDistributedTokenProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Fields ---</span></span><br><span class="line">    <span class="keyword">private</span> IMemcachedClient _memcache;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Constructors ---</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DistributedTokenProvider</span>(<span class="params">IMemcachedClient memcache</span>)</span> &#123;</span><br><span class="line">        _memcache = memcache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Methods ---</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IDictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; <span class="title">GetDistributedTokens</span>(<span class="params">IEnumerable&lt;<span class="built_in">string</span>&gt; keys</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(keys.Count() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        keys = keys.Distinct().ToArray();</span><br><span class="line">        <span class="keyword">var</span> result = _memcache.Get(keys);</span><br><span class="line">        <span class="keyword">return</span> result.ToDictionary(kv =&gt; kv.Key, kv =&gt; SysUtil.ChangeType&lt;<span class="built_in">string</span>&gt;(kv.Value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetDistributedToken</span>(<span class="params"><span class="built_in">string</span> key</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _memcache.Get&lt;<span class="built_in">string</span>&gt;(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">InitToken</span>(<span class="params"><span class="built_in">string</span> key</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// we have an internal utility for generating random memcache-friendly key strings,</span></span><br><span class="line">        <span class="comment">// point is, make the key safe and unique</span></span><br><span class="line">        <span class="keyword">return</span> key + <span class="string">&quot;:&quot;</span> + StringUtil.CreateAlphaNumericKey(<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DistributeToken</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">string</span> token, TimeSpan ttl</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> expires = GlobalClock.UtcNow + ttl;</span><br><span class="line">        <span class="keyword">if</span>(expires != DateTime.MaxValue) &#123;</span><br><span class="line">            _memcache.Store(StoreMode.Set, key, token, expires);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _memcache.Store(StoreMode.Set, key, token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">InitDistributedToken</span>(<span class="params"><span class="built_in">string</span> key, TimeSpan ttl</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> token = InitToken(key);</span><br><span class="line">        DistributeToken(key, token, ttl);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Next, we wrap our general-purpose distributed token logic in an easy to call utility. We can use this both in the tenant manager as well as the downstream application servers.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TenantLifecycleTokenProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Class Fields ---</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> TOKEN_KEY = <span class="string">&quot;TOKEN_TENANT&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> TimeSpan TOKEN_TTL = TimeSpan.FromSeconds(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Fields ---</span></span><br><span class="line">    <span class="keyword">private</span> IDistributedTokenProvider _tokenProvider;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _token = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Constructors ---</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TenantLifecycleTokenProvider</span>(<span class="params">IDistributedTokenProvider tokenProvider</span>)</span> &#123;</span><br><span class="line">        _tokenProvider = tokenProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//--- Methods ---</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetToken</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(_token == <span class="literal">null</span>) &#123;</span><br><span class="line">            _token = _tokenProvider.GetDistributedToken(TOKEN_KEY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> _token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">InitToken</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        _token = _tokenProvider.InitDistributedToken(TOKEN_KEY, TOKEN_TTL);</span><br><span class="line">        <span class="keyword">return</span> _token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Instead of sending an HTTP payload to different IP addresses in a pool of application servers, now the tenant manager simply does this:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tenantId = <span class="string">&#x27;12345&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> lifecycleProvider = <span class="keyword">new</span> TenantLifecycleTokenProvider(_tokenFactory.NewDistributedTokenProvider(tenantId));</span><br><span class="line">lifecycleProvider.InitToken();</span><br></pre></td></tr></table></figure><p>A downstream application server, when it handles an incoming request for a tenant, first checks if it can lookup an in-memory copy of the tenant’s configuration. If not, it fetches it from the site configuration authority <em>and</em> looks up the tenant’s lifecycle token. If the lifecycle token for this tenant is not yet initialized (it may not have been if the tenant manager didn’t need to restart the tenant), then the application server initialize it, so that other application servers in the pool can know the current lifecycle state of the tenant.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tenantId = <span class="string">&#x27;12345&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> tenantConfiguration = siteConfigurationAuthorityConnector.getTenantConfiguration(tenantId);</span><br><span class="line"><span class="keyword">var</span> lifecycleToken = lifecycleTokenProvider.GetToken();</span><br><span class="line"><span class="keyword">if</span>(lifecycleToken == <span class="literal">null</span>) &#123;</span><br><span class="line">    lifecycleToken = lifecycleTokenProvider.InitToken();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> tenant = <span class="keyword">new</span> Tenant(tenantConfiguration, lifecycleToken);</span><br><span class="line">tenants.Add(tenant.Id, tenant);</span><br></pre></td></tr></table></figure><p>When handling an incoming request, the application server checks if the tenant needs to be restarted before fulfilling the request. If the distributed lifecycle token has changed since we last read it and no longer matches the tenant’s lifecycle token, we know that the tenant manager is asking for a tenant restart.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tenantId = <span class="string">&#x27;12345&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> tenant = tenant.Get(tenantId);</span><br><span class="line"><span class="keyword">var</span> lifecycleToken = lifecycleTokenProvider.GetToken();</span><br><span class="line"><span class="keyword">if</span>(tenant.LifecycleToken != lifecycleToken) &#123;</span><br><span class="line">    tenant = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In our particular architecture, nullifying the tenant at this stage triggers the application server to instantiate a new <code>Tenant</code> object and register it in the lookup, as seen above. This process is repeated for all application servers. The addition or reduction of containers or pods does not affect the tenant manager’s ability to restart tenants.</p><p>I am absolutely <em>not</em> a critic of service discovery in principal. When necessary to facilitate <em>direct communication</em> with components on a network, it can be a life-saver. However, if your use case does not require direct communication and eventual consistency among downstream data, and application state is acceptable for your use case, consider reactive programming solutions. Everything will be ok (eventually)!</p><p>…and if it’s not, you can always deploy systems to handle those situations out-of-band:</p><div class="video-container"><iframe src="https://www.youtube.com/embed/mxKhbU_ToMs" frameborder="0" loading="lazy" allowfullscreen></iframe></div></div></article><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Posts</a></li><li><a href="/#projects">Projects</a></li><li><a href="/atom.xml">Atom</a></li><li><a href="/plan">.plan</a></li></ul></div><div id="toc-footer" style="display:none"></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&text=You May Not Need Service Discovery"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&is_video=false&description=You May Not Need Service Discovery"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=You May Not Need Service Discovery&body=Check out this article: https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&title=You May Not Need Service Discovery"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&name=You May Not Need Service Discovery&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://modethirteen.com/2019/12/23/you-may-not-need-service-discovery/&t=You May Not Need Service Discovery"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2014-2021 James Andrew Vaughn (Andy)</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Posts</a></li><li><a href="/#projects">Projects</a></li><li><a href="/atom.xml">Atom</a></li><li><a href="/plan">.plan</a></li></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">$((function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",(function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()}))}))</script><script src="/js/main.js"></script></body></html>