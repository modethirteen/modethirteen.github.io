<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="You can have your CPU and RAM back..."><meta property="og:type" content="article"><meta property="og:title" content="What Can Apache Events and Workers Do for You?"><meta property="og:url" content="https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/index.html"><meta property="og:site_name" content="al&#x3D;0x13"><meta property="og:description" content="You can have your CPU and RAM back..."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/0_XFC0-JClTkkgF3CO.jpg"><meta property="article:published_time" content="2019-03-10T22:23:30.000Z"><meta property="article:modified_time" content="2020-11-27T23:06:27.000Z"><meta property="article:author" content="James Andrew Vaughn (Andy)"><meta property="article:tag" content="Programming"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Performance"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/0_XFC0-JClTkkgF3CO.jpg"><meta name="twitter:creator" content="@modethirteen"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>What Can Apache Events and Workers Do for You?</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="al=0x13" type="application/atom+xml">
</head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Posts</a></li><li><a href="/#projects">Projects</a></li><li><a href="/atom.xml">Atom</a></li><li><a href="/plan">.plan</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="/2019/06/07/cryptography-101/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/2019/01/25/demystifying-authorization-and-authentication-flows/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&text=What Can Apache Events and Workers Do for You?"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&is_video=false&description=What Can Apache Events and Workers Do for You?"><i class="fab fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=What Can Apache Events and Workers Do for You?&body=Check out this article: https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/"><i class="fas fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&name=What Can Apache Events and Workers Do for You?&description="><i class="fab fa-tumblr" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&t=What Can Apache Events and Workers Do for You?"><i class="fab fa-hacker-news" aria-hidden="true"></i></a></li></ul></div><div id="toc"></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">What Can Apache Events and Workers Do for You?</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">James Andrew Vaughn (Andy)</span></span><div class="postdate"><time datetime="2019-03-10T22:23:30.000Z" itemprop="datePublished">2019-03-10</time></div><div class="article-tag"><i class="fas fa-tag"></i> <a class="tag-link-link" href="/tags/DevOps/" rel="tag">DevOps</a>, <a class="tag-link-link" href="/tags/Performance/" rel="tag">Performance</a>, <a class="tag-link-link" href="/tags/Programming/" rel="tag">Programming</a></div></div></header><div class="content" itemprop="articleBody"><p class="description">You can have your CPU and RAM back...</p><p><img src="/2019/03/10/what-can-apache-events-and-workers-do-for-you/0_XFC0-JClTkkgF3CO.jpg" alt="Image"><span class="caption">Image: <a target="_blank" rel="noopener" href="https://unsplash.com/@ianjbattaglia">Ian Battaglia</a></span></p><p>There are <em>too many to count</em> articles about configuring Apache or NGINX to optimize for multi-process, multi-threaded scenarios with one or more downstream, detached processors of HTTP requests (<a target="_blank" rel="noopener" href="https://www.php.net/manual/en/install.fpm.php">PHP-FPM</a>, <a target="_blank" rel="noopener" href="https://www.phusionpassenger.com/">Passenger</a>, <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-apache">ASP.NET</a>, etc.). This post won‚Äôt be addressing the step-by-step configuration details. The key takeaway from most articles, that‚Äôs relevant here, is that it is often very taxing on high-load, performance-critical web servers when all possible request handlers and processors are engaged to satisfy every incoming client request - regardless of context. For example, a web server process doesn‚Äôt <em>need</em> <code>ruby</code> to load a static JavaScript file off disk.</p><p>Due to <a target="_blank" rel="noopener" href="https://mindtouch.com/">MindTouch</a>‚Äòs <a href="/2014/11/10/continuous-delivery-without-breaking-everything/" title="evolution">evolution</a> from delivering downloadable packages for on-premise installs to handling deployment ourselves in a SaaS model, decisions regarding <em>how</em> a web server should be configured to best run our platform were not made by us in the early days. We adopted what seemed to be the most common way to run PHP (our middleware web layout application) with Apache: the <a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/2.4/mod/prefork.html">Apache Prefork MPM</a> (Multi-Processing Model) with the <code>mod_php</code> module. <em>Preforking</em> is quite nice and straightforward for serving HTML and static resources such as JavaScript, CSS, and images. With the addition of <code>mod_php</code>, every web server process that is forked from the main process has all the tools it needs to handle any supported incoming requests.</p><p>MindTouch also had a unique requirement: a <code>mono</code> (.NET) hosted API host with its own rules for handling incoming requests. We used <code>mod_proxy</code> to direct traffic for a specific path segment to that downstream request handler.</p><p><img src="/2019/03/10/what-can-apache-events-and-workers-do-for-you/0.png" alt="Image"></p><p>‚Ä¶and this is how things probably would have remained if it wasn‚Äôt for <em>this</em> eventual problem:</p><p><img src="/2019/03/10/what-can-apache-events-and-workers-do-for-you/2.png" alt="Image"></p><p><em>Update 2020-11-27</em>: It is worth mentioning that MindTouch now deploys these components as containers on <a target="_blank" rel="noopener" href="https://aws.amazon.com/eks">Amazon EKS</a> (k8s). When this post was written, all components described ran on EC2 application servers (with every application server configured with the same components).</p><p>Yes, on an average day, while our core API processes required less than 40% of available resources, <code>httpd</code> (with its bulky PHP add-on) spiked and was often CPU-bound. We analyzed traffic and found that we were loading the entire PHP interpreter to handle PHP-unnecessary requests such as images, JavaScript, and the API. We quickly realized we were not being particularly efficient with our compute resources. Much of our asset delivery was already handled through a content delivery network (CDN) as well, so we weren‚Äôt even getting the worst of it.</p><p>We chose to implement worker threads with the <a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/2.4/mod/event.html">Event MPM</a> for a leaner web server process. <del>Our longer-term plans include an initiative to deploy our web server, PHP middleware, and API host on separately scalable units (likely <a target="_blank" rel="noopener" href="https://www.docker.com/resources/what-container">containers</a>), so breaking apart these components seemed like a step in achieving that goal as well.</del> (<em>Update 2020-11-27</em>: Done!) MindTouch‚Äôs hands-on VP of Technology, <a target="_blank" rel="noopener" href="https://www.linkedin.com/in/pete-erickson-b3455a1">Pete Erickson</a>, was very instrumental in allowing me to execute these changes safely.</p><p><img src="/2019/03/10/what-can-apache-events-and-workers-do-for-you/1.png" alt="Image"></p><p>For a quick course in how threads operate in this context, I‚Äôll do my best with the next few sentences (using the diagram above as a visual aid). The main web server process spawns child processes each with available worker threads and a single listener thread. The worker threads can be assigned to any incoming request received by the web server, and are expected to route the request to the appropriate downstream handler (the file system if fetching a static file, Fast CGI if another interpreter is necessary, etc.). This is already a much more efficient way to handle high rates of web traffic for different downstream destinations. However, the use of <em>events</em> and the listener thread makes this deployment fire on all cylinders.</p><p>Typically the worker thread would be <em>bound</em> to the web server socket, waiting for the downstream work to complete before returning some sort of response to the upstream client who originally sent the request. A CPU thread doesn‚Äôt <em>need</em> to sit around and do nothing while an operating system is trying to locate a file on disk, PHP is processing the received data, or the API is performing work. The listener thread <em>listens</em> for events fired from the main web server process socket queue of incoming requests and the operating system. It works with the process‚Äôs thread pool to determine when a worker thread needs to be called up to handle inbound or outbound communication for the webserver. If a request is presently being handled by a different process, there is no need for a web server thread to be tied up, and it can be available to handle incoming requests.</p><p>Incidentally, for you JavaScript enthusiasts, if this sounds a bit like concurrency as provided by the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop">JavaScript Event Loop</a>, it‚Äôs not üòõ! While some similar benefits are realized in <a target="_blank" rel="noopener" href="https://nodejs.org/">Node.js</a>, such as non-blocking I/O, JavaScript achieves this by managing a <em>single</em> thread very well. In the example above, we are talking about a <em>multi-threaded</em> solution, which is a good use case to apply <em>parallel computing</em>.</p><p>After tuning the number of child processes and threads, the outcome, with the same steady request rate, were significant:</p><p><img src="/2019/03/10/what-can-apache-events-and-workers-do-for-you/3.png" alt="Image"></p><p>We traded a collection of nearly CPU-bound Apache processes, for 15-20% utilization by PHP-FPM (the visualized ‚Äúcliff‚Äù for the <code>httpd</code> processes represents when this change was fully rolled out to production servers). Getting the configuration right required a lot of testing and a lot of dead ‚Äúcanaries‚Äù, but the breathing room that we gained back led to a significantly more stable service for our customers (with more room for the occasional spike) and a much happier DevOps team!</p></div></article><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Posts</a></li><li><a href="/#projects">Projects</a></li><li><a href="/atom.xml">Atom</a></li><li><a href="/plan">.plan</a></li></ul></div><div id="toc-footer" style="display:none"></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&text=What Can Apache Events and Workers Do for You?"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&is_video=false&description=What Can Apache Events and Workers Do for You?"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=What Can Apache Events and Workers Do for You?&body=Check out this article: https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&title=What Can Apache Events and Workers Do for You?"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&name=What Can Apache Events and Workers Do for You?&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://modethirteen.com/2019/03/10/what-can-apache-events-and-workers-do-for-you/&t=What Can Apache Events and Workers Do for You?"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2014-2020 James Andrew Vaughn (Andy)</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Posts</a></li><li><a href="/#projects">Projects</a></li><li><a href="/atom.xml">Atom</a></li><li><a href="/plan">.plan</a></li></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">$((function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",(function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()}))}))</script><script src="/js/main.js"></script></body></html>